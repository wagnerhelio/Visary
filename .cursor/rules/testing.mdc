---
description: Django testing - complete and mandatory coverage for all functionalities
alwaysApply: true
globs: ["visary/**/tests.py", "visary/**/models.py", "visary/**/views.py"]
---

# Django Testing - Complete and Mandatory Coverage

## Fundamental Principle

**ALWAYS create and maintain complete tests for all functionalities**. Tests are mandatory and must be created/updated immediately after any code creation or modification.

## Mandatory Rules

### 1. Test Structure

- **ALWAYS use `tests.py` in all Django apps**
- Each Django app must have its `tests.py` file with complete coverage
- Organize tests by class, grouping related tests (ex: `TestUserModel`, `TestUserViews`, `TestUserServices`)

### 2. Test Creation and Update

**ALWAYS create or update tests when:**
- **Creating new function/method**: create tests immediately after implementing
- **Modifying existing function**: update existing tests or create new ones if necessary
- **Creating new model**: create complete tests for model
- **Modifying model**: update existing tests
- **Creating new view**: create tests for all HTTP methods (GET, POST, PUT, DELETE, etc.)
- **Modifying view**: update existing tests
- **Adding field to model**: add tests for new field validation
- **Removing field from model**: update tests removing field references

**Mandatory process:**
1. **Implement functionality**
2. **Immediately after, create/update tests**
3. **Execute tests to validate**
4. **Fix code or tests until 100% success**

### 3. Test Coverage - Mandatory

**ALL tests below are mandatory and must be implemented:**

#### 3.1. Model Tests

**ALWAYS test:**
- Valid instance creation
- Required field validation
- Optional field validation
- Data type validation
- Size/limit validation
- Format validation (EmailField, URLField, etc.)
- Unique value validation
- Choices validation
- Representation test (`__str__()`, `__repr__()`)
- Model method test
- Property test

#### 3.2. ForeignKey and Relationship Tests

**ALWAYS test:**
- Creation with valid ForeignKey
- Creation with invalid ForeignKey
- Cascade delete, Protect delete, Set null delete
- ManyToMany relationships
- OneToOne relationships
- Reverse access via `related_name`
- Referential integrity

#### 3.3. Field Tests

**ALWAYS test for each field:**
- Required field without value
- Required field with valid value
- Optional field without value
- Optional field with value
- Invalid value by type
- Invalid value by format
- Invalid value by size
- Invalid value by business rule
- Default value
- Unique value

#### 3.4. View Tests

**ALWAYS test for each view:**
- GET without authentication
- GET with authentication
- GET with permission
- GET without permission
- POST with valid data
- POST with invalid data
- POST without authentication
- POST without permission
- PUT/PATCH with valid data
- PUT/PATCH with invalid data
- DELETE with authentication
- DELETE without permission
- Correct response status codes
- Correct template rendering
- Correct context
- Redirection
- Forms, Pagination, Filters, Ordering

#### 3.5. Session Control Tests

**ALWAYS test:**
- Login creates session correctly
- Logout destroys session correctly
- Expired session behavior
- Invalid session behavior
- Multiple sessions
- Session cookies configuration
- Session persistence
- Session cleanup on logout

### 4. Complete Flow Tests

**ALWAYS create complete flow tests that:**
- Follow system standard flow
- Test in isolation
- Cover real scenarios
- Validate final state
- Validate side effects

### 5. Test Execution - Mandatory After Implementation

**ALWAYS execute complete tests after:**
- Creating new functionality
- Modifying existing functionality
- Fixing bug
- Refactoring code
- Finishing implementation

**Execution Commands:**
```powershell
# Activate venv
& .\.venv\Scripts\Activate.ps1

# Execute all tests
python visary/manage.py test

# Execute tests of specific app
python visary/manage.py test consultancy
python visary/manage.py test system

# Execute tests with verbosity
python visary/manage.py test --verbosity=2
```

**Mandatory Validation:**
- 100% of tests must pass: no test can fail
- No test can be skipped: all tests must execute
- Complete coverage: all scenarios must be tested
- Tests must be fast and isolated

### 6. Recommended Test Structure

Organize tests following this structure:
```python
from django.test import TestCase, Client
from django.contrib.auth.models import User
from django.urls import reverse
from .models import YourModel

class TestYourModel(TestCase):
    def setUp(self):
        pass
    
    def test_model_creation_valid(self):
        pass
    
    def test_model_required_fields(self):
        pass

class TestYourViews(TestCase):
    def setUp(self):
        self.client = Client()
        self.user = User.objects.create_user(...)
    
    def test_view_get_authenticated(self):
        pass
```

### 7. Process Obligatory

**ALWAYS follow this process:**
1. Implement functionality
2. Create/update tests immediately after implementation
3. Execute tests to validate implementation
4. Fix code or tests until 100% success
5. Validate complete coverage
6. Execute complete suite of app tests
7. Confirm system is 100% functional and stable

**NEVER finish implementation without complete and passing tests.**

### 8. Exceptions

**No exceptions**: tests are mandatory for all functionalities. If a functionality doesn't have tests, it's not complete.
