---
description: Mandatory response format - always show diffs, explanations, evidence, test results and flow diagrams in chat
alwaysApply: true
globs: ["*"]
---

# Response Format - Mandatory Structure

## Fundamental Principle

**EVERY response must follow this exact structure in the chat**. This format is **MANDATORY and DEFINITIVE** for all actions, corrections, implementations, and analyses.

## Mandatory Response Structure

### 1. Code Diff (OBRIGATÓRIO)

**ALWAYS show code changes in unified diff format** directly in chat response:

```diff
--- arquivo_antes.py
+++ arquivo_depois.py
@@ -linha_inicial,numero_linhas +linha_inicial,numero_linhas @@
 contexto antes
-conteúdo removido
+conteúdo adicionado
 contexto depois
```

**Rules:**
- Show complete diff of ALL changes made
- Include context lines (3-5 lines before/after changes)
- Use proper diff syntax with `-` for removals and `+` for additions
- Group changes by file
- Show line numbers when relevant

### 2. Explanation of Changes (OBRIGATÓRIO)

**ALWAYS explain:**
- **What changed**: specific lines, functions, classes modified
- **Why changed**: reason for the change (bug fix, improvement, refactoring, requirement)
- **Impact**: what parts of the system are affected

**Format:**
```
## O Que Mudou

- Arquivo: `caminho/arquivo.py`
- Linhas: 15-23
- Função: `nome_funcao()`
- Alteração: [descrição específica]

## Por Que Mudou

- Problema identificado: [descrição]
- Solução aplicada: [descrição]
- Benefício: [descrição]

## Impacto

- Arquivos afetados: [lista]
- Dependências: [lista]
- Compatibilidade: [análise]
```

### 3. Evidence of Improvement (OBRIGATÓRIO)

**ALWAYS provide summarized evidence** proving the change is better:

**Format:**
```
## Evidências de Melhoria

### Antes
- Problema: [descrição com evidência]
- Código problemático: [snippet ou referência]
- Impacto negativo: [descrição]

### Depois
- Solução: [descrição]
- Código corrigido: [snippet ou referência]
- Benefício: [descrição mensurável]

### Comparação
- Performance: [melhoria se aplicável]
- Segurança: [melhoria se aplicável]
- Manutenibilidade: [melhoria se aplicável]
- Testabilidade: [melhoria se aplicável]
```

**Rules:**
- Provide concrete evidence, not assumptions
- Cite specific code lines, functions, or patterns
- Show measurable improvements when possible
- Compare before/after clearly

### 4. Test Results (OBRIGATÓRIO)

**ALWAYS execute and show test results** after any code change:

**Format:**
```
## Resultados dos Testes

### Comando Executado
```powershell
python visary/manage.py test [app.tests]
```

### Saída Completa
```
[output completo dos testes]
```

### Resumo
- Total de testes: [número]
- Testes passaram: [número] ✅
- Testes falharam: [número] ❌
- Cobertura: [porcentagem se disponível]
- Tempo de execução: [tempo]

### Análise
- [Análise dos resultados]
- [Correções aplicadas se houver falhas]
- [Validação final]
```

**Rules:**
- Execute tests after EVERY code change
- Show complete test output
- Provide summary with pass/fail counts
- If tests fail, show fixes applied
- Validate all tests pass before considering task complete

### 5. Flow Diagram (OBRIGATÓRIO)

**ALWAYS include a Mermaid flow diagram** showing how the code/system works:

**Format:**
```mermaid
flowchart TD
    A[Início] --> B{Decisão}
    B -->|Condição 1| C[Ação 1]
    B -->|Condição 2| D[Ação 2]
    C --> E[Resultado]
    D --> E
    E --> F[Fim]
```

**Rules:**
- Create diagram for:
  - Function/method flow
  - Class interactions
  - System architecture changes
  - Data flow
  - Process workflows
- Use appropriate Mermaid diagram types:
  - `flowchart` for general flows
  - `sequenceDiagram` for interactions
  - `classDiagram` for class relationships
  - `stateDiagram` for state machines
- Map diagram elements to actual code (functions, classes, modules)
- Include all relevant decision points and paths

**Exception:**
- If diagram is not feasible, explicitly state: `"Nota: Diagrama Mermaid omitido porque [razão específica]"`

## Complete Response Template

Every response MUST follow this structure:

```
## Resumo Executivo
[2-5 linhas descrevendo o que foi feito]

## 1. Diff do Código
[diff completo em formato unificado]

## 2. O Que Mudou e Por Que
[explicação detalhada]

## 3. Evidências de Melhoria
[provas resumidas]

## 4. Resultados dos Testes
[output completo + resumo]

## 5. Diagrama de Fluxo
[mermaid diagram]

## Validação Final
- [ ] Código implementado
- [ ] Testes passando
- [ ] Sem erros de sintaxe
- [ ] Migrations geradas (se aplicável)
- [ ] Documentação atualizada (se aplicável)
```

## Exceptions

**NO EXCEPTIONS** for the response format structure. Even if:
- Change is minimal (still show diff)
- Tests are not applicable (show validation command output)
- Diagram is complex (simplify but still provide)
- Time is limited (format is mandatory)

## Integration with Other Rules

- This format applies to ALL responses, regardless of other rules
- Code changes are still implemented directly (not in files)
- Diffs, explanations, tests, and diagrams are shown IN CHAT, not in files
- This rule complements execution-mode.mdc: implement code directly, but explain in structured format in chat
