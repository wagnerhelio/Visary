{
  "meta": {
    "project": "Visary - Sistema de Gestão de Consultoria de Vistos",
    "date": "2026-01-15",
    "prepared_by": "Generated by TestSprite"
  },
  "product_overview": "Visary is a comprehensive web-based visa consultancy management system developed with Django. It enables visa consultancy companies to manage the entire lifecycle of visa processes for their clients, including client management, travel organization, dynamic visa forms, partner management, financial control, and user permissions.",
  "core_goals": [
    "Enable efficient client registration and management through configurable registration steps and detailed client profiles.",
    "Organize and manage trips, including destination countries and visa types, associated with clients for visa processing.",
    "Facilitate tracking and management of visa processes with customizable checklists, statuses, and progress monitoring.",
    "Support dynamic and customizable visa forms per visa type, with client response handling.",
    "Provide a client portal for form submission, process tracking, and travel overview.",
    "Manage partner relationships and their associated clients for referral tracking.",
    "Maintain financial controls with payment tracking and status management.",
    "Implement a robust permission system for users, modules, and profiles to secure and control feature access."
  ],
  "key_features": [
    "Configurable multi-step client registration with address lookup via multiple CEP APIs and dependent management.",
    "Comprehensive trip management including countries, visa types, travel dates, and client associations.",
    "Visa process management with customizable process steps, statuses, deadlines, and progress computation.",
    "Dynamic visa form creation per visa type with various question types and response storage.",
    "Secure client area featuring dashboards, form viewing, and response submission.",
    "Partner management for indicator partners with segment classification and active status control.",
    "Financial management with payment recording, status updates, and observation notes.",
    "Permission system organizing users by profiles and modules with CRUD-based access permissions.",
    "Internal APIs for CEP lookup, client data retrieval, visa types listing, process status and deadlines.",
    "Administrative features including superuser creation, profile and module management, and database migrations."
  ],
  "user_flow_summary": [
    "Client registration performed via configurable stepwise forms including personal data, address with CEP auto-fill, passport data, and dependent addition/removal.",
    "Administrator or authorized user creates and manages trips linking countries, visa types, travel dates, and multiple clients.",
    "Visa processes are created for client-trip pairs, tracked through configurable steps with status updates and progress calculation.",
    "Admin users create and manage visa forms customized by visa type; clients fill and submit responses via their portal.",
    "Partners are registered and linked to clients they referred, with management of activation status and details.",
    "Financial entries are recorded per client-trip, with payment status updates and administrative notes.",
    "User authentication and authorization performed via session-based login; permissions control interface components and operation privileges.",
    "Clients access their dashboard, view trips, complete visa form questionnaires, and monitor visa process statuses securely."
  ],
  "validation_criteria": [
    "All core models and views function as specified: client, trip, process, form, partner, financial, and permission management.",
    "CEP address lookup integrates successfully with multiple APIs and falls back properly if needed.",
    "Dynamic forms enforce required fields and store client responses correctly, supporting different question types.",
    "Process steps and statuses update correctly, with deadlines managed and overall progress accurately calculated.",
    "Financial transactions are tracked with correct payment status and history.",
    "Permission system restricts and grants access as configured per user profiles and modules.",
    "Client portal authentication and data display operate securely and without errors.",
    "Admin commands for migrations, superuser creation, and data seeding execute successfully.",
    "APIs respond with accurate data based on input parameters, supporting frontend and internal integration needs."
  ],
  "code_summary": {
    "tech_stack": {
      "framework": "Django 5.2.8",
      "language": "Python",
      "database": "SQLite3",
      "authentication": "Django Authentication",
      "template_engine": "Django Templates",
      "dependencies": [
        "brazilcep",
        "pycep-correios",
        "python-dotenv",
        "django-environ",
        "requests",
        "aiohttp"
      ]
    },
    "main_features": [
      {
        "name": "Gerenciamento de Clientes",
        "description": "Cadastro, edição e visualização de clientes e dependentes. Busca de CEP via API.",
        "models": [
          "ClienteConsultoria"
        ],
        "views": [
          "cadastrar_cliente_view",
          "editar_cliente_view",
          "visualizar_cliente",
          "listar_clientes",
          "adicionar_dependente",
          "remover_dependente"
        ]
      },
      {
        "name": "Gerenciamento de Processos",
        "description": "Criação e acompanhamento de processos de visto com etapas e status.",
        "models": [
          "Processo",
          "EtapaProcesso",
          "StatusProcesso",
          "ViagemStatusProcesso"
        ],
        "views": [
          "criar_processo",
          "editar_processo",
          "visualizar_processo",
          "listar_processos"
        ]
      },
      {
        "name": "Gerenciamento de Formulários",
        "description": "Criação e gerenciamento de formulários de visto com perguntas e opções de seleção.",
        "models": [
          "FormularioVisto",
          "PerguntaFormulario",
          "OpcaoSelecao",
          "RespostaFormulario"
        ],
        "views": [
          "criar_formulario",
          "editar_formulario",
          "listar_formularios",
          "criar_pergunta",
          "editar_pergunta"
        ]
      },
      {
        "name": "Gerenciamento de Viagens",
        "description": "Cadastro de viagens, países de destino e tipos de visto.",
        "models": [
          "Viagem",
          "PaisDestino",
          "TipoVisto",
          "ClienteViagem"
        ],
        "views": [
          "listar_viagens",
          "listar_paises_destino",
          "listar_tipos_visto"
        ]
      },
      {
        "name": "Gerenciamento de Partners",
        "description": "Cadastro e gerenciamento de parceiros/fornecedores.",
        "models": [
          "Partner"
        ],
        "views": [
          "criar_partner",
          "editar_partner",
          "visualizar_partner",
          "listar_partners"
        ]
      },
      {
        "name": "Gerenciamento Financeiro",
        "description": "Controle financeiro com baixas de pagamento.",
        "models": [
          "Financeiro"
        ],
        "views": [
          "home_financeiro",
          "listar_financeiro",
          "dar_baixa_financeiro"
        ]
      },
      {
        "name": "Sistema de Etapas de Cadastro",
        "description": "Configuração de etapas e campos customizados para cadastro de clientes.",
        "models": [
          "EtapaCadastroCliente",
          "CampoEtapaCliente"
        ],
        "views": [
          "criar_etapa_cadastro",
          "editar_etapa_cadastro",
          "listar_etapas_cadastro"
        ]
      },
      {
        "name": "Sistema de Permissões",
        "description": "Gestão de usuários, perfis e módulos com controle de acesso.",
        "models": [
          "UsuarioConsultoria",
          "Perfil",
          "Modulo"
        ],
        "views": [
          "criar_usuario",
          "editar_usuario",
          "listar_usuarios",
          "criar_perfil",
          "editar_perfil",
          "listar_perfis"
        ]
      },
      {
        "name": "Área do Cliente",
        "description": "Dashboard e visualização de formulários para clientes.",
        "views": [
          "cliente_dashboard",
          "cliente_visualizar_formulario",
          "cliente_salvar_resposta"
        ]
      }
    ],
    "architecture": {
      "type": "Monolithic Django Application",
      "apps": [
        "consultancy",
        "system"
      ],
      "url_structure": "Modular com include de URLs por app - TODAS as URLs do app 'system' têm prefixo '/system/'",
      "url_prefix": "/system/",
      "template_structure": "Templates organizados por funcionalidade"
    },
    "authentication": {
      "method": "Session-based authentication (Django sessions)",
      "login_url": "/login/",
      "login_form_fields": {
        "identifier": "Campo 'identifier' (não 'username') - aceita email ou username",
        "password": "Campo 'password'",
        "remember_me": "Campo opcional 'remember_me' (checkbox)"
      },
      "csrf_required": true,
      "csrf_token_extraction": "Token CSRF deve ser extraído da página de login via regex",
      "csrf_token_field": "csrfmiddlewaretoken",
      "session_cookies": "Usar requests.Session() para manter cookies de sessão",
      "protected_routes": "Maioria das rotas requer autenticação via @login_required"
    },
    "url_structure": {
      "base_url": "http://localhost:8000",
      "url_prefix": "/system/",
      "important_note": "TODAS as URLs do app 'system' têm prefixo '/system/' (ex: /system/clientes/cadastrar/, /system/api/buscar-cep/)",
      "url_patterns": {
        "api_buscar_cep": "/system/api/buscar-cep/",
        "api_dados_cliente": "/system/clientes/dados/",
        "api_cliente_info": "/system/api/cliente-info/",
        "api_prazo_status_processo": "/system/api/prazo-status-processo/",
        "cadastrar_cliente": "/system/clientes/cadastrar/",
        "criar_processo": "/system/processos/criar/",
        "criar_formulario": "/system/formularios/tipos/criar/",
        "listar_viagens": "/system/viagens/listar/",
        "criar_partner": "/system/partners/criar/",
        "home_financeiro": "/system/financeiro/",
        "listar_financeiro": "/system/financeiro/listar/"
      }
    },
    "apis": {
      "internal": [
        {
          "name": "api_buscar_cep",
          "url": "/system/api/buscar-cep/",
          "method": "GET",
          "requires_auth": true,
          "required_parameters": {"cep": "string"},
          "returns": {"success": {"cep": "string", "street": "string", "district": "string", "city": "string", "uf": "string", "complement": "string"}, "error": {"error": "string"}},
          "note": "All APIs require authentication. api_buscar_cep returns keys in English (street, district, city, uf)"
        },
        {
          "name": "api_dados_cliente",
          "url": "/system/clientes/dados/",
          "method": "GET",
          "requires_auth": true,
          "required_parameters": {"cliente_id": "integer"},
          "returns": {"success": {"data_base": "string", "cliente": {"nome": "string"}}, "error": {"error": "string"}},
          "note": "Requires cliente_id parameter. Returns data_base (date) and cliente.nome"
        },
        {
          "name": "api_cliente_info",
          "url": "/system/api/cliente-info/",
          "method": "GET",
          "requires_auth": true,
          "required_parameters": {"cliente_id": "integer"},
          "returns": {"success": {"criado_em": "string"}, "error": {"error": "string"}},
          "note": "Requires cliente_id parameter. Returns ONLY criado_em (ISO datetime), NOT full client details like id, name, email, etc."
        },
        {
          "name": "api_prazo_status_processo",
          "url": "/system/api/prazo-status-processo/",
          "method": "GET",
          "requires_auth": true,
          "required_parameters": {"status_id": "integer"},
          "returns": {"success": {"prazo_padrao_dias": "integer"}, "error": {"error": "string"}},
          "note": "Requires status_id parameter (NOT processo_id). Returns prazo_padrao_dias (days)"
        }
      ]
    },
    "testing_guidelines": {
      "authentication": "Use session-based authentication: 1) GET /login/ to get CSRF token, 2) POST /login/ with 'identifier' (not 'username'), 'password', and 'csrfmiddlewaretoken' using allow_redirects=False, 3) IMMEDIATELY after POST, check sessionid cookie in session.cookies.get_dict() BEFORE following redirects, 4) If sessionid cookie exists, login succeeded (accept status 200 OR 302), 5) If sessionid cookie does NOT exist, login failed even with status 302, 6) AFTER verifying cookie, follow redirect manually or use allow_redirects=True, 7) Use requests.Session() to maintain cookies",
      "csrf_handling": "For POST requests: Extract CSRF token from form page HTML using regex pattern: name=[\"']csrfmiddlewaretoken[\"']\\s+value=[\"']([^\"']+)[\"'], include 'csrfmiddlewaretoken' in POST data. CSRF token may be rotated after login, get new token from form page if needed",
      "url_prefix": "ALL system app URLs require '/system/' prefix. API endpoints also require this prefix. Example: /system/api/buscar-cep/ (note: hyphen in 'buscar-cep')",
      "response_format": "Most Django views return HTML pages, not JSON. Only internal API endpoints return JSON. For HTML responses, check for content in response.text instead of response.json()",
      "login_implementation": "import requests; import re; session = requests.Session(); login_page = session.get('http://localhost:8000/login/'); csrf_match = re.search(r'name=[\"']csrfmiddlewaretoken[\"']\\s+value=[\"']([^\"']+)[\"']', login_page.text); csrf_token = csrf_match.group(1) if csrf_match else ''; login_payload = {'identifier': 'admin', 'password': 'admin', 'csrfmiddlewaretoken': csrf_token}; login_resp = session.post('http://localhost:8000/login/', data=login_payload, headers={'Referer': 'http://localhost:8000/login/'}, allow_redirects=False); assert login_resp.status_code in (200, 302), f'Login failed: {login_resp.status_code}'; assert 'sessionid' in session.cookies.get_dict(), 'Session cookie not set after login - login failed even with status 302'; if login_resp.status_code == 302: location = login_resp.headers.get('Location'); if location: session.get(f'http://localhost:8000{location}', timeout=30, allow_redirects=True)",
      "authentication_verification": {
        "redirects_after_login": "After successful login, Django returns 302 redirect to '/' (LOGIN_REDIRECT_URL). Use allow_redirects=True to follow redirects automatically. Status 302 is NOT a failure, it means successful login with redirect.",
        "session_cookie_verification": "CRITICAL: After POST /login/ with allow_redirects=False, IMMEDIATELY check for sessionid cookie: assert 'sessionid' in session.cookies.get_dict(). This check must happen BEFORE following any redirects. The sessionid cookie is set in the Set-Cookie header of the POST /login/ response when status is 302. If cookie not present in session.cookies.get_dict() after POST (even with status 302), login failed. The cookie must be verified right after the POST response, before allow_redirects=True or manual redirect following. Cookie name is 'sessionid' by default. To debug: print(session.cookies.get_dict()) immediately after POST to see all cookies.",
        "valid_auth_check_urls": ["/", "/system/clientes/", "/system/processos/", "/system/financeiro/"],
        "invalid_auth_check_urls": ["/system/"],
        "verification_code_example": "login_resp = session.post(LOGIN_URL, data=login_payload, headers=headers, timeout=30, allow_redirects=False); assert login_resp.status_code in (200, 302), f'Login failed: {login_resp.status_code}'; cookies_after_login = session.cookies.get_dict(); assert 'sessionid' in cookies_after_login, f'CRITICAL: Session cookie not set after login POST. Cookies present: {list(cookies_after_login.keys())}. Login failed even if status is {login_resp.status_code}. Check session.cookies.get_dict() IMMEDIATELY after POST, before following redirects.'; if login_resp.status_code == 302: location = login_resp.headers.get('Location'); if location: session.get(f'{BASE_URL}{location}', timeout=30, allow_redirects=True); protected_resp = session.get('http://localhost:8000/system/clientes/', timeout=30); assert protected_resp.status_code == 200, f'Not authenticated, got status {protected_resp.status_code}. URL: {protected_resp.url}'; assert 'login' not in protected_resp.url.lower(), 'Still on login page'"
      }
    }
  }
}
