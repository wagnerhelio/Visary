{% extends "base.html" %}
{% load static tz dict_filters %}

{% block title %}Visary | Cadastrar Cliente{% endblock %}

{% block base_styles %}
    {{ block.super }}

    .layout-grid {
        display: grid;
        gap: 24px;
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
    }

    .grid-inline {
        display: grid;
        gap: 18px;
        grid-template-columns: 1fr;
    }

    .card {
        background: var(--card-bg);
        border-radius: 24px;
        border: 1px solid var(--border-soft);
        box-shadow: 0 24px 48px rgba(5, 8, 17, 0.5);
        padding: clamp(18px, 3.5vw, 28px);
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
    }

    .etapas-navegacao {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
        padding: 20px;
        background: rgba(12, 19, 35, 0.4);
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .etapa-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        flex: 1;
        position: relative;
    }

    .etapa-item::after {
        content: '';
        position: absolute;
        top: 20px;
        left: 50%;
        width: 100%;
        height: 2px;
        background: rgba(255, 255, 255, 0.1);
        z-index: 0;
    }

    .etapa-item:last-child::after {
        display: none;
    }

    .etapa-numero {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.9rem;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.2);
        color: rgba(245, 245, 245, 0.6);
        position: relative;
        z-index: 1;
    }

    .etapa-item.ativa .etapa-numero {
        background: linear-gradient(135deg, var(--accent), var(--accent-strong));
        border-color: var(--accent);
        color: #081423;
    }

    .etapa-item.concluida .etapa-numero {
        background: rgba(86, 244, 156, 0.3);
        border-color: rgba(86, 244, 156, 0.6);
        color: rgba(86, 244, 156, 0.95);
    }

    .etapa-item.concluida .etapa-numero::after {
        content: "‚úì";
    }

    .etapa-nome {
        font-size: 0.85rem;
        color: rgba(245, 245, 245, 0.6);
        text-align: center;
    }

    .etapa-item.ativa .etapa-nome {
        color: rgba(245, 245, 245, 0.95);
        font-weight: 600;
    }

    .etapa-item.concluida .etapa-nome {
        color: rgba(86, 244, 156, 0.9);
    }

    .etapa-conteudo {
        display: none;
    }

    .etapa-conteudo.ativa {
        display: block;
    }

    .form-card form {
        display: grid;
        gap: 16px;
    }

    .form-card label {
        display: block;
        font-size: 0.82rem;
        font-weight: 600;
        color: rgba(245, 245, 245, 0.8);
        margin-bottom: 8px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
    }

    .form-card input,
    .form-card select,
    .form-card textarea {
        width: 100%;
        min-width: 0;
        padding: 14px 16px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(12, 19, 35, 0.72);
        color: #f5f5f5;
        font-size: 0.95rem;
        transition: border 0.2s ease, box-shadow 0.2s ease;
    }

    .form-card input::placeholder,
    .form-card textarea::placeholder {
        color: rgba(245, 245, 245, 0.55);
    }

    .form-card select {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        padding-right: 42px;
        background-image: linear-gradient(45deg, transparent 50%, rgba(245, 245, 245, 0.75) 50%),
                          linear-gradient(135deg, rgba(245, 245, 245, 0.75) 50%, transparent 50%);
        background-position: calc(100% - 24px) center, calc(100% - 16px) center;
        background-size: 8px 8px;
        background-repeat: no-repeat;
    }

    .form-card input:focus,
    .form-card select:focus,
    .form-card textarea:focus {
        outline: none;
        border-color: rgba(86, 244, 156, 0.65);
        box-shadow: 0 0 0 4px rgba(86, 244, 156, 0.12);
        background: rgba(12, 19, 35, 0.85);
    }

    .form-actions {
        display: flex;
        gap: 12px;
        justify-content: space-between;
        margin-top: 24px;
        padding-top: 24px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .form-actions .btn-group {
        display: flex;
        gap: 12px;
    }

    @media (min-width: 1120px) {
        .layout-grid {
            display: grid;
            grid-template-columns: 1fr;
            max-width: 700px;
        }

        .grid-inline {
            grid-template-columns: repeat(2, minmax(240px, 1fr));
        }
    }

    @media (max-width: 768px) {
        .layout-grid {
            width: 100%;
            max-width: 100%;
            margin: 0;
            gap: 16px;
            padding: 0;
        }

        .etapas-navegacao {
            padding: 16px 12px;
            margin-bottom: 20px;
        }

        .etapa-nome {
            font-size: 0.75rem;
        }

        .etapa-numero {
            width: 32px;
            height: 32px;
            font-size: 0.8rem;
        }

        .card.form-card,
        .layout-grid > .card {
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 16px 12px;
            border-radius: 18px;
            box-shadow: 0 16px 32px rgba(5, 8, 17, 0.45);
            box-sizing: border-box;
        }

        .form-card label {
            font-size: 0.78rem;
            margin-bottom: 6px;
        }

        .form-card input,
        .form-card select,
        .form-card textarea {
            padding: 10px 12px;
            font-size: 0.9rem;
        }

        .form-actions {
            flex-direction: column;
        }

        .form-actions .btn-group {
            width: 100%;
            flex-direction: column;
        }
    }
{% endblock %}

{% block app_header %}
<section class="page-header">
    <div class="page-header__titles">
        <h1>Cadastrar Cliente</h1>
        <p>Preencha os dados em etapas para cadastrar um novo cliente.</p>
    </div>
</section>
{% endblock %}

{% block app_content %}

{# Logs no console do navegador (n√£o exibidos na tela) #}
{% if debug_logs_json %}
<script>
    (function() {
        const logs = {{ debug_logs_json|safe }};
        if (logs && logs.length > 0) {
            console.group('%cüîç Debug - Cadastro de Cliente', 'color: #56f49c; font-weight: bold; font-size: 14px;');
            logs.forEach(function(log) {
                const timestamp = log.timestamp || '';
                const message = log.message || '';
                const level = log.level || 'info';
                const prefix = timestamp ? `[${timestamp}] ` : '';
                
                const style = {
                    'info': 'color: #56f49c;',
                    'warning': 'color: #ffd700;',
                    'error': 'color: #ff6868;',
                    'debug': 'color: #9ca3af;'
                }[level] || 'color: #56f49c;';
                
                const consoleMethod = {
                    'error': console.error,
                    'warning': console.warn,
                    'debug': console.debug
                }[level] || console.log;
                
                consoleMethod('%c' + prefix + message, style);
            });
            console.groupEnd();
        }
    })();
</script>
{% endif %}

<section class="layout-grid">
    <article class="card">
        <div class="etapas-navegacao">
            {% for etapa in etapas %}
                <div class="etapa-item {% if etapa.pk == etapa_atual.pk %}ativa{% elif dados_temporarios and etapa.campo_booleano and etapa.campo_booleano in dados_temporarios %}concluida{% endif %}">
                    <div class="etapa-numero">{{ etapa.ordem }}</div>
                    <div class="etapa-nome">{{ etapa.nome }}</div>
                </div>
            {% endfor %}
        </div>
    </article>

    <article class="card form-card">
        <header>
            <h2>Etapa {{ etapa_atual.ordem }}: {{ etapa_atual.nome }}</h2>
            {% if etapa_atual.descricao %}
                <p style="margin-top: 8px; color: rgba(245, 245, 245, 0.7); font-size: 0.9rem;">{{ etapa_atual.descricao }}</p>
            {% endif %}
        </header>
        <form method="post" novalidate>
            {% csrf_token %}
            {% if form.non_field_errors %}
                <ul class="messages">
                    {% for error in form.non_field_errors %}
                        <li class="error">{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}

            {# Campos ocultos das outras etapas #}
            {% for etapa in etapas %}
                {% if etapa.pk != etapa_atual.pk %}
                    {% for campo_etapa in etapa.campos.all %}
                        {% if campo_etapa.nome_campo != 'confirmar_senha' %}
                            {% if cliente %}
                                {% with valor_campo=cliente|getattr_filter:campo_etapa.nome_campo %}
                                    {% if campo_etapa.nome_campo == 'assessor_responsavel' %}
                                        <input type="hidden" name="{{ campo_etapa.nome_campo }}" value="{{ cliente.assessor_responsavel.pk|default:'' }}">
                                    {% elif campo_etapa.nome_campo == 'parceiro_indicador' %}
                                        <input type="hidden" name="{{ campo_etapa.nome_campo }}" value="{{ cliente.parceiro_indicador.pk|default:'' }}">
                                    {% elif campo_etapa.tipo_campo == 'data' and valor_campo %}
                                        <input type="hidden" name="{{ campo_etapa.nome_campo }}" value="{{ valor_campo|date:'Y-m-d' }}">
                                    {% elif valor_campo %}
                                        <input type="hidden" name="{{ campo_etapa.nome_campo }}" value="{{ valor_campo }}">
                                    {% endif %}
                                {% endwith %}
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                {% endif %}
            {% endfor %}

            {# Renderizar campos da etapa atual #}
            {% for campo_etapa in campos_etapa %}
                {% if campo_etapa.nome_campo in form.fields %}
                    {% with field=form|get_form_field:campo_etapa.nome_campo %}
                        {% if field %}
                            {# Campo CEP com bot√£o de busca e UF #}
                            {% if campo_etapa.nome_campo == 'cep' %}
                                <div class="grid-inline">
                                    <div>
                                        <label for="{{ field.id_for_label }}">{{ field.label }}{% if campo_etapa.obrigatorio %} *{% endif %}</label>
                                        <div style="display: flex; gap: 8px; align-items: flex-start;">
                                            <div style="flex: 1;">
                                                {{ field }}
                                            </div>
                                            <button type="button" id="btn-buscar-cep" class="btn btn-outline" style="white-space: nowrap; padding: 14px 18px;">
                                                Buscar
                                            </button>
                                        </div>
                                        {{ field.errors }}
                                    </div>
                                    {# Renderizar UF junto com CEP se estiver na mesma etapa #}
                                    {% for c in campos_etapa %}
                                        {% if c.nome_campo == 'uf' %}
                                            {% with uf_field=form|get_form_field:'uf' %}
                                                {% if uf_field %}
                                                    <div>
                                                        <label for="{{ uf_field.id_for_label }}">{{ uf_field.label }}{% if c.obrigatorio %} *{% endif %}</label>
                                                        {{ uf_field }}
                                                        {{ uf_field.errors }}
                                                    </div>
                                                {% endif %}
                                            {% endwith %}
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {# Pular campo UF se j√° foi renderizado com CEP #}
                            {% elif campo_etapa.nome_campo == 'uf' %}
                                {# S√≥ renderizar UF se CEP n√£o estiver na mesma etapa (j√° foi renderizado com CEP) #}
                                {% if not tem_cep_na_etapa %}
                                    <div>
                                        <label for="{{ field.id_for_label }}">{{ field.label }}{% if campo_etapa.obrigatorio %} *{% endif %}</label>
                                        {{ field }}
                                        {{ field.errors }}
                                    </div>
                                {% endif %}
                            {# Campo Senha com Confirmar Senha #}
                            {% elif campo_etapa.nome_campo == 'senha' %}
                                <div class="grid-inline">
                                    <div>
                                        <label for="{{ field.id_for_label }}">{{ field.label }}{% if campo_etapa.obrigatorio %} *{% endif %}</label>
                                        {{ field }}
                                        {{ field.errors }}
                                    </div>
                                    {% with confirmar_senha_field=form|get_form_field:'confirmar_senha' %}
                                        {% if confirmar_senha_field %}
                                            <div>
                                                <label for="{{ confirmar_senha_field.id_for_label }}">{{ confirmar_senha_field.label }}{% if campo_etapa.obrigatorio %} *{% endif %}</label>
                                                {{ confirmar_senha_field }}
                                                {{ confirmar_senha_field.errors }}
                                            </div>
                                        {% endif %}
                                    {% endwith %}
                                </div>
                            {# Campos que devem aparecer em grid de 2 colunas (telefone, data_nascimento, nacionalidade) #}
                            {% elif campo_etapa.nome_campo == 'telefone' or campo_etapa.nome_campo == 'telefone_secundario' or campo_etapa.nome_campo == 'data_nascimento' or campo_etapa.nome_campo == 'nacionalidade' %}
                                {% if forloop.counter0|divisibleby:2 or forloop.first %}
                                    <div class="grid-inline">
                                {% endif %}
                                    <div>
                                        <label for="{{ field.id_for_label }}">{{ field.label }}{% if campo_etapa.obrigatorio %} *{% endif %}</label>
                                        {{ field }}
                                        {{ field.errors }}
                                    </div>
                                {% if forloop.counter|divisibleby:2 or forloop.last %}
                                    </div>
                                {% endif %}
                            {# Campos de endere√ßo que devem aparecer em grid (numero, complemento, bairro, cidade) #}
                            {% elif campo_etapa.nome_campo == 'numero' or campo_etapa.nome_campo == 'complemento' or campo_etapa.nome_campo == 'bairro' or campo_etapa.nome_campo == 'cidade' %}
                                {% if campo_etapa.nome_campo == 'numero' %}
                                    <div class="grid-inline">
                                {% endif %}
                                    <div>
                                        <label for="{{ field.id_for_label }}">{{ field.label }}{% if campo_etapa.obrigatorio %} *{% endif %}</label>
                                        {{ field }}
                                        {{ field.errors }}
                                    </div>
                                {% if campo_etapa.nome_campo == 'complemento' or campo_etapa.nome_campo == 'cidade' %}
                                    </div>
                                {% endif %}
                            {# Pular campo confirmar_senha se j√° foi renderizado com senha #}
                            {% elif campo_etapa.nome_campo == 'confirmar_senha' %}
                                {# S√≥ renderizar confirmar_senha se senha n√£o estiver na mesma etapa (j√° foi renderizado com senha) #}
                                {% if not tem_senha_na_etapa %}
                                    <div>
                                        <label for="{{ field.id_for_label }}">{{ field.label }}{% if campo_etapa.obrigatorio %} *{% endif %}</label>
                                        {{ field }}
                                        {{ field.errors }}
                                    </div>
                                {% endif %}
                            {# Campo tipo_passaporte_outro - escondido inicialmente, mostrado quando tipo_passaporte = "outro" #}
                            {% elif campo_etapa.nome_campo == 'tipo_passaporte_outro' %}
                                <div id="div_tipo_passaporte_outro" style="display: none;">
                                    <label for="{{ field.id_for_label }}">{{ field.label }}{% if campo_etapa.obrigatorio %} *{% endif %}</label>
                                    {{ field }}
                                    {{ field.errors }}
                                </div>
                            {# Campos de passaporte que devem aparecer em grid (data_emissao_passaporte, valido_ate_passaporte) #}
                            {% elif campo_etapa.nome_campo == 'data_emissao_passaporte' or campo_etapa.nome_campo == 'valido_ate_passaporte' %}
                                {% if campo_etapa.nome_campo == 'data_emissao_passaporte' %}
                                    <div class="grid-inline">
                                {% endif %}
                                    <div>
                                        <label for="{{ field.id_for_label }}">{{ field.label }}{% if campo_etapa.obrigatorio %} *{% endif %}</label>
                                        {{ field }}
                                        {{ field.errors }}
                                    </div>
                                {% if campo_etapa.nome_campo == 'valido_ate_passaporte' %}
                                    </div>
                                {% endif %}
                            {# Campos padr√£o (um por linha) #}
                            {% else %}
                                <div>
                                    <label for="{{ field.id_for_label }}">{{ field.label }}{% if campo_etapa.obrigatorio %} *{% endif %}</label>
                                    {{ field }}
                                    {{ field.errors }}
                                </div>
                            {% endif %}
                        {% endif %}
                    {% endwith %}
                {% endif %}
            {% endfor %}

            <div class="form-actions">
                <button type="submit" name="acao" value="cancelar" class="btn btn-outline">
                    Cancelar Cadastro
                </button>
                <div class="btn-group">
                    {% if etapa_anterior %}
                        <a href="?etapa_id={{ etapa_anterior.pk }}" class="btn btn-outline">
                            Voltar
                        </a>
                    {% endif %}
                    {% if proxima_etapa %}
                        <button type="submit" class="btn btn-primary">
                            Pr√≥xima Etapa
                        </button>
                    {% else %}
                        <button type="submit" name="acao" value="finalizar" class="btn btn-primary">
                            Finalizar Cadastro
                        </button>
                        <button type="submit" name="acao" value="finalizar_e_criar_viagem" class="btn btn-primary" style="background: linear-gradient(135deg, #56f49c 0%, #4dd0e1 100%);">
                            Finalizar e Criar Viagem
                        </button>
                    {% endif %}
                </div>
            </div>
        </form>
        
        {# Se√ß√£o especial para etapa de membros - Formul√°rio de cadastro de dependente (FORA do formul√°rio principal) #}
        {% if etapa_atual.campo_booleano == 'etapa_membros' and cliente and form_dependente %}
            <div style="margin-top: 32px; padding: 24px; background: rgba(86, 244, 156, 0.1); border: 1px solid rgba(86, 244, 156, 0.3); border-radius: 12px;">
                <h3 style="margin: 0 0 16px 0; font-size: 1.2rem; color: rgba(86, 244, 156, 0.95);">Adicionar Membros (Dependentes)</h3>
                
                {% if dependentes_temporarios %}
                <div style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 12px 0; font-size: 1rem; color: var(--text-primary);">
                        Dependentes Adicionados ({{ dependentes_temporarios|length }})
                        <span style="font-size: 0.85rem; color: rgba(86, 244, 156, 0.8); font-weight: normal;">(ser√£o salvos ao finalizar)</span>
                    </h4>
                    {% for dependente in dependentes_temporarios %}
                        <div style="padding: 12px; background: rgba(86, 244, 156, 0.05); border: 1px solid rgba(86, 244, 156, 0.2); border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>{{ dependente.nome|default:"Sem nome" }}</strong>
                                {% if dependente.email %}
                                    <br><span style="font-size: 0.85rem; color: var(--text-secondary);">{{ dependente.email }}</span>
                                {% endif %}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <form method="post" style="margin: 0;">
                                    {% csrf_token %}
                                    <input type="hidden" name="acao" value="editar_dependente">
                                    <input type="hidden" name="dependente_index" value="{{ forloop.counter0 }}">
                                    <button type="submit" class="btn btn-outline" style="padding: 6px 12px; font-size: 0.85rem; background: rgba(86, 244, 156, 0.1); border-color: rgba(86, 244, 156, 0.3); color: rgba(86, 244, 156, 0.9);">
                                        Editar
                                    </button>
                                </form>
                                <form method="post" style="margin: 0;">
                                    {% csrf_token %}
                                    <input type="hidden" name="acao" value="remover_dependente">
                                    <input type="hidden" name="dependente_index" value="{{ forloop.counter0 }}">
                                    <button type="submit" class="btn btn-outline" style="padding: 6px 12px; font-size: 0.85rem; background: rgba(255, 82, 82, 0.1); border-color: rgba(255, 82, 82, 0.3); color: rgba(255, 82, 82, 0.9);" onclick="return confirm('Deseja remover este membro?');">
                                        Remover
                                    </button>
                                </form>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                {# Bot√£o para mostrar formul√°rio (oculto se houver erros no formul√°rio ou se estiver editando) #}
                {% with editando_dependente=request.GET.editando_dependente|default:"" %}
                <div id="btn-adicionar-membro-container" style="margin-bottom: 20px; display: {% if form_dependente.errors or editando_dependente %}none{% else %}block{% endif %};">
                    <button type="button" id="btn-adicionar-membro" class="btn btn-primary" style="display: flex; align-items: center; gap: 8px;">
                        <span>+</span>
                        <span>Adicionar Membro</span>
                    </button>
                </div>
                
                {# Formul√°rio de cadastro de dependente (inicialmente oculto, mas vis√≠vel se houver erros ou se estiver editando) #}
                <div id="formulario-dependente-container" style="display: {% if form_dependente.errors or editando_dependente %}block{% else %}none{% endif %};">
                    <form method="post" novalidate id="form-dependente">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="dependente">
                        <input type="hidden" name="assessor_responsavel" value="{{ cliente.assessor_responsavel.pk }}">
                        
                        <h4 style="margin: 0 0 16px 0; font-size: 1rem; color: var(--text-primary);">
                            {% if editando_dependente %}Editar Dependente{% else %}Novo Dependente{% endif %}
                        </h4>
                        
                        {# Op√ß√£o para usar email e senha do cliente principal #}
                        {% with email_field=form_dependente|get_form_field:'email' %}
                            {% if email_field and cliente.email %}
                            {% with usar_dados_post=request.POST.usar_dados_cliente_principal|default:"" %}
                            {% with usar_dados_editando=dependente_editando_dados.usar_dados_cliente_principal|default:False %}
                            <div style="margin-bottom: 20px; padding: 16px; background: rgba(86, 244, 156, 0.05); border: 1px solid rgba(86, 244, 156, 0.2); border-radius: 8px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin: 0;">
                                    <input type="checkbox" id="usar-dados-cliente-principal" name="usar_dados_cliente_principal" {% if usar_dados_post == 'on' or usar_dados_editando %}checked{% endif %} style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="color: var(--text-primary); font-weight: 500;">Usar email e senha do cliente principal</span>
                                </label>
                                <p style="margin: 8px 0 0 26px; font-size: 0.85rem; color: var(--text-secondary);">
                                    O dependente usar√° o mesmo email ({{ cliente.email }}) e senha do cliente principal para login.
                                </p>
                            </div>
                            {% endwith %}
                            {% endwith %}
                            {% endif %}
                        {% endwith %}
                        
                        {# Renderizar campos organizados por etapa: Dados Pessoais, Endere√ßo, Passaporte #}
                        {% for etapa_dep in etapas_dependente %}
                            <div style="margin-top: {% if not forloop.first %}24px{% endif %}; padding-top: {% if not forloop.first %}24px{% endif %}; border-top: {% if not forloop.first %}1px solid rgba(86, 244, 156, 0.2){% endif %};">
                                <h5 style="margin: 0 0 16px 0; font-size: 0.95rem; color: rgba(86, 244, 156, 0.9); font-weight: 600;">
                                    {{ etapa_dep.nome }}
                                </h5>
                                
                                {% for campo_etapa in campos_dependente %}
                                    {% if campo_etapa.etapa.pk == etapa_dep.pk and campo_etapa.nome_campo in form_dependente.fields %}
                                        {% with field=form_dependente|get_form_field:campo_etapa.nome_campo %}
                                            {% if field %}
                                                {# Pular assessor_responsavel pois j√° est√° como hidden #}
                                                {% if campo_etapa.nome_campo == 'assessor_responsavel' %}
                                                    {# J√° est√° como hidden #}
                                                {# Pular parceiro_indicador - dependentes n√£o devem ter parceiro #}
                                                {% elif campo_etapa.nome_campo == 'parceiro_indicador' %}
                                                    {# Dependentes n√£o devem ter parceiro indicador #}
                                                {# Campo CEP com bot√£o de busca e UF #}
                                                {% elif campo_etapa.nome_campo == 'cep' %}
                                                    <div class="grid-inline">
                                                        <div>
                                                            <label for="{{ field.id_for_label }}">{{ field.label }}{% if campo_etapa.obrigatorio %} *{% endif %}</label>
                                                            <div style="display: flex; gap: 8px; align-items: flex-start;">
                                                                <div style="flex: 1;">
                                                                    {{ field }}
                                                                </div>
                                                                <button type="button" class="btn-buscar-cep-dependente btn btn-outline" style="white-space: nowrap; padding: 14px 18px;">
                                                                    Buscar
                                                                </button>
                                                            </div>
                                                            {{ field.errors }}
                                                        </div>
                                                        {# Renderizar UF junto com CEP se estiver na mesma etapa #}
                                                        {% for c in campos_dependente %}
                                                            {% if c.etapa.pk == etapa_dep.pk and c.nome_campo == 'uf' %}
                                                                {% with uf_field=form_dependente|get_form_field:'uf' %}
                                                                    {% if uf_field %}
                                                                        <div>
                                                                            <label for="{{ uf_field.id_for_label }}">{{ uf_field.label }}{% if c.obrigatorio %} *{% endif %}</label>
                                                                            {{ uf_field }}
                                                                            {{ uf_field.errors }}
                                                                        </div>
                                                                    {% endif %}
                                                                {% endwith %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                {# Pular campo UF se j√° foi renderizado com CEP #}
                                                {% elif campo_etapa.nome_campo == 'uf' %}
                                                    {# S√≥ renderizar UF se CEP n√£o estiver na mesma etapa #}
                                                    {% with cep_na_etapa=False %}
                                                        {% for c in campos_dependente %}
                                                            {% if c.etapa.pk == etapa_dep.pk and c.nome_campo == 'cep' %}
                                                                {% with cep_na_etapa=True %}{% endwith %}
                                                            {% endif %}
                                                        {% endfor %}
                                                        {% if not cep_na_etapa %}
                                                            <div>
                                                                <label for="{{ field.id_for_label }}">{{ field.label }}{% if campo_etapa.obrigatorio %} *{% endif %}</label>
                                                                {{ field }}
                                                                {{ field.errors }}
                                                            </div>
                                                        {% endif %}
                                                    {% endwith %}
                                                {# Campo Email com op√ß√£o de usar do cliente principal #}
                                                {% elif campo_etapa.nome_campo == 'email' %}
                                                    <div id="email-dependente-container">
                                                        <label for="{{ field.id_for_label }}">{{ field.label }}{% if campo_etapa.obrigatorio %} *{% endif %}</label>
                                                        {{ field }}
                                                        {{ field.errors }}
                                                    </div>
                                                {# Campo Senha com Confirmar Senha #}
                                                {% elif campo_etapa.nome_campo == 'senha' %}
                                                    <div class="grid-inline" id="senha-dependente-container">
                                                        <div>
                                                            <label for="{{ field.id_for_label }}">{{ field.label }}{% if campo_etapa.obrigatorio %} *{% endif %}</label>
                                                            {{ field }}
                                                            {{ field.errors }}
                                                        </div>
                                                        {% with confirmar_senha_field=form_dependente|get_form_field:'confirmar_senha' %}
                                                            {% if confirmar_senha_field %}
                                                                <div>
                                                                    <label for="{{ confirmar_senha_field.id_for_label }}">{{ confirmar_senha_field.label }}{% if campo_etapa.obrigatorio %} *{% endif %}</label>
                                                                    {{ confirmar_senha_field }}
                                                                    {{ confirmar_senha_field.errors }}
                                                                </div>
                                                            {% endif %}
                                                        {% endwith %}
                                                    </div>
                                                {# Pular confirmar_senha se j√° foi renderizado com senha #}
                                                {% elif campo_etapa.nome_campo == 'confirmar_senha' %}
                                                    {# J√° foi renderizado com senha acima #}
                                                {# Campo tipo_passaporte_outro (aparece condicionalmente) #}
                                                {% elif campo_etapa.nome_campo == 'tipo_passaporte_outro' %}
                                                    <div id="div-tipo-passaporte-outro-dependente" style="display: none;">
                                                        <label for="{{ field.id_for_label }}">{{ field.label }}{% if campo_etapa.obrigatorio %} *{% endif %}</label>
                                                        {{ field }}
                                                        {{ field.errors }}
                                                    </div>
                                                {# Campos que devem aparecer em grid de 2 colunas #}
                                                {% elif campo_etapa.nome_campo == 'telefone' or campo_etapa.nome_campo == 'telefone_secundario' or campo_etapa.nome_campo == 'data_nascimento' or campo_etapa.nome_campo == 'nacionalidade' or campo_etapa.nome_campo == 'data_emissao_passaporte' or campo_etapa.nome_campo == 'valido_ate_passaporte' %}
                                                    {% if forloop.counter0|divisibleby:2 or forloop.first %}
                                                        <div class="grid-inline">
                                                    {% endif %}
                                                        <div>
                                                            <label for="{{ field.id_for_label }}">{{ field.label }}{% if campo_etapa.obrigatorio %} *{% endif %}</label>
                                                            {{ field }}
                                                            {{ field.errors }}
                                                        </div>
                                                    {% if forloop.counter|divisibleby:2 or forloop.last %}
                                                        </div>
                                                    {% endif %}
                                                {# Campos padr√£o #}
                                                {% else %}
                                                    <div>
                                                        <label for="{{ field.id_for_label }}">{{ field.label }}{% if campo_etapa.obrigatorio %} *{% endif %}</label>
                                                        {{ field }}
                                                        {{ field.errors }}
                                                    </div>
                                                {% endif %}
                                            {% endif %}
                                        {% endwith %}
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endfor %}
                        
                        <div style="margin-top: 20px; display: flex; gap: 12px;">
                            <button type="submit" class="btn btn-primary">
                                {% if editando_dependente %}Salvar Altera√ß√µes{% else %}Adicionar Dependente{% endif %}
                            </button>
                            <button type="button" id="btn-cancelar-dependente" class="btn btn-outline">
                                Cancelar Membro
                            </button>
                        </div>
                    </form>
                </div>
                {% endwith %}
            </div>
            
            {# JavaScript para controlar visibilidade do formul√°rio #}
            <script>
            (function() {
                const btnAdicionar = document.getElementById('btn-adicionar-membro');
                const btnCancelar = document.getElementById('btn-cancelar-dependente');
                const containerForm = document.getElementById('formulario-dependente-container');
                const containerBtn = document.getElementById('btn-adicionar-membro-container');
                
                if (!btnAdicionar || !containerForm) return;
                
                // Verificar se h√° erros no formul√°rio - se houver, manter vis√≠vel
                const formHasErrors = containerForm.style.display === 'block';
                
                // Mostrar formul√°rio ao clicar em "Adicionar Membro"
                btnAdicionar.addEventListener('click', function() {
                    containerForm.style.display = 'block';
                    if (containerBtn) {
                        containerBtn.style.display = 'none';
                    }
                    // Scroll suave at√© o formul√°rio
                    containerForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                });
                
                // Esconder formul√°rio ao clicar em "Cancelar"
                if (btnCancelar) {
                    btnCancelar.addEventListener('click', function() {
                        containerForm.style.display = 'none';
                        if (containerBtn) {
                            containerBtn.style.display = 'block';
                        }
                        // Limpar formul√°rio
                        const form = document.getElementById('form-dependente');
                        if (form) {
                            form.reset();
                            // Limpar mensagens de erro
                            const errorElements = form.querySelectorAll('.errorlist, .error');
                            errorElements.forEach(function(el) {
                                el.remove();
                            });
                        }
                        // Resetar checkbox
                        const checkbox = document.getElementById('usar-dados-cliente-principal');
                        if (checkbox) checkbox.checked = false;
                    });
                }
                
                // Controlar checkbox "Usar dados do cliente principal"
                const checkboxUsarDados = document.getElementById('usar-dados-cliente-principal');
                if (checkboxUsarDados) {
                    const emailField = document.querySelector('#email-dependente-container input[name="email"]');
                    const senhaField = document.querySelector('#senha-dependente-container input[name="senha"]');
                    const confirmarSenhaField = document.querySelector('#senha-dependente-container input[name="confirmar_senha"]');
                    const emailContainer = document.getElementById('email-dependente-container');
                    const senhaContainer = document.getElementById('senha-dependente-container');
                    
                    {% if cliente.email %}
                    const emailClientePrincipal = '{{ cliente.email|escapejs }}';
                    {% else %}
                    const emailClientePrincipal = '';
                    {% endif %}
                    
                    function toggleUsarDadosCliente() {
                        const usarDados = checkboxUsarDados.checked;
                        
                        if (usarDados && emailClientePrincipal) {
                            // Preencher email
                            if (emailField) {
                                emailField.value = emailClientePrincipal;
                                emailField.readOnly = true;
                                emailField.style.backgroundColor = 'rgba(86, 244, 156, 0.1)';
                                emailField.style.cursor = 'not-allowed';
                            }
                            
                            // Ocultar e tornar opcionais os campos de senha
                            if (senhaContainer) {
                                senhaContainer.style.display = 'none';
                            }
                            if (senhaField) {
                                senhaField.required = false;
                                senhaField.value = '';
                            }
                            if (confirmarSenhaField) {
                                confirmarSenhaField.required = false;
                                confirmarSenhaField.value = '';
                            }
                        } else {
                            // Restaurar campos
                            if (emailField) {
                                emailField.value = '';
                                emailField.readOnly = false;
                                emailField.style.backgroundColor = '';
                                emailField.style.cursor = '';
                                emailField.required = true;
                            }
                            
                            // Mostrar campos de senha
                            if (senhaContainer) {
                                senhaContainer.style.display = '';
                            }
                            if (senhaField) {
                                senhaField.required = true;
                            }
                            if (confirmarSenhaField) {
                                confirmarSenhaField.required = true;
                            }
                        }
                    }
                    
                    checkboxUsarDados.addEventListener('change', toggleUsarDadosCliente);
                    
                    // Executar uma vez ao carregar para aplicar estado inicial se checkbox j√° estiver marcado
                    // Isso garante que o estado seja aplicado mesmo ap√≥s recarregamento com erros
                    if (checkboxUsarDados.checked) {
                        toggleUsarDadosCliente();
                    }
                }
            })();
            </script>
            
            {# JavaScript para buscar CEP e controlar tipo_passaporte_outro no formul√°rio de dependente #}
            <script>
            (function() {
                // Buscar CEP no formul√°rio de dependente
                const btnBuscarCepDependente = document.querySelector('.btn-buscar-cep-dependente');
                if (btnBuscarCepDependente) {
                    const formDependente = document.getElementById('form-dependente');
                    if (formDependente) {
                        const cepInputDependente = formDependente.querySelector('[name="cep"]');
                        
                        if (cepInputDependente) {
                            // M√°scara de CEP
                            cepInputDependente.addEventListener('input', function(e) {
                                let value = e.target.value.replace(/\D/g, '');
                                if (value.length > 5) {
                                    value = value.substring(0, 5) + '-' + value.substring(5, 8);
                                }
                                e.target.value = value;
                            });
                            
                            // Fun√ß√£o para buscar e preencher campos de endere√ßo
                            async function buscarCepDependente() {
                                const cep = cepInputDependente.value.replace(/\D/g, '');
                                if (cep.length !== 8) {
                                    alert('CEP deve conter 8 d√≠gitos.');
                                    return;
                                }
                                
                                btnBuscarCepDependente.disabled = true;
                                btnBuscarCepDependente.textContent = 'Buscando...';
                                
                                try {
                                    const resp = await fetch('{% url "system:api_buscar_cep" %}?cep=' + cep);
                                    const data = await resp.json();
                                    
                                    if (!resp.ok) {
                                        if (data.error) {
                                            alert(data.error);
                                        }
                                        return;
                                    }
                                    
                                    // Preencher campos de endere√ßo
                                    const campos = {
                                        logradouro: formDependente.querySelector('[name="logradouro"]'),
                                        bairro: formDependente.querySelector('[name="bairro"]'),
                                        cidade: formDependente.querySelector('[name="cidade"]'),
                                        uf: formDependente.querySelector('[name="uf"]')
                                    };
                                    
                                    function preencherCampo(field, value) {
                                        if (field && value) {
                                            field.value = value;
                                            field.dispatchEvent(new Event('input', { bubbles: true }));
                                            field.dispatchEvent(new Event('change', { bubbles: true }));
                                        }
                                    }
                                    
                                    preencherCampo(campos.logradouro, data.street);
                                    preencherCampo(campos.bairro, data.district);
                                    preencherCampo(campos.cidade, data.city);
                                    preencherCampo(campos.uf, (data.uf || '').toUpperCase());
                                    
                                } catch (e) {
                                    console.error('Erro ao buscar CEP:', e);
                                    alert('Erro ao buscar CEP. Tente novamente.');
                                } finally {
                                    btnBuscarCepDependente.disabled = false;
                                    btnBuscarCepDependente.textContent = 'Buscar';
                                }
                            }
                            
                            btnBuscarCepDependente.addEventListener('click', buscarCepDependente);
                            cepInputDependente.addEventListener('keypress', function(e) {
                                if (e.key === 'Enter') {
                                    e.preventDefault();
                                    buscarCepDependente();
                                }
                            });
                        }
                    }
                }
                
                // Controlar visibilidade de tipo_passaporte_outro no formul√°rio de dependente
                function initTipoPassaporteDependente() {
                    const formDependente = document.getElementById('form-dependente');
                    if (!formDependente) return;
                    
                    const tipoPassaporteSelect = formDependente.querySelector('[name="tipo_passaporte"]');
                    const tipoPassaporteOutroDiv = document.getElementById('div-tipo-passaporte-outro-dependente');
                    const tipoPassaporteOutroField = formDependente.querySelector('[name="tipo_passaporte_outro"]');
                    
                    if (!tipoPassaporteSelect || !tipoPassaporteOutroDiv) {
                        setTimeout(initTipoPassaporteDependente, 100);
                        return;
                    }
                    
                    function toggleTipoPassaporteOutro() {
                        if (tipoPassaporteSelect.value === 'outro') {
                            tipoPassaporteOutroDiv.style.display = 'block';
                            if (tipoPassaporteOutroField) {
                                tipoPassaporteOutroField.required = true;
                            }
                        } else {
                            tipoPassaporteOutroDiv.style.display = 'none';
                            if (tipoPassaporteOutroField) {
                                tipoPassaporteOutroField.required = false;
                                tipoPassaporteOutroField.value = '';
                            }
                        }
                    }
                    
                    toggleTipoPassaporteOutro();
                    tipoPassaporteSelect.addEventListener('change', toggleTipoPassaporteOutro);
                }
                
                // Inicializar quando o formul√°rio de dependente for exibido
                const containerForm = document.getElementById('formulario-dependente-container');
                if (containerForm) {
                    const observer = new MutationObserver(function(mutations) {
                        if (containerForm.style.display === 'block') {
                            setTimeout(initTipoPassaporteDependente, 100);
                        }
                    });
                    observer.observe(containerForm, { attributes: true, attributeFilter: ['style'] });
                    
                    // Inicializar imediatamente se j√° estiver vis√≠vel
                    if (containerForm.style.display === 'block') {
                        setTimeout(initTipoPassaporteDependente, 100);
                    }
                }
            })();
            </script>
        {% endif %}
    </article>
</section>

{% for campo_etapa in campos_etapa %}
    {% if campo_etapa.nome_campo == 'cep' %}
<script>
(function() {
    const cepInput = document.getElementById('{{ form.cep.id_for_label }}');
    const btnBuscarCep = document.getElementById('btn-buscar-cep');
    if (!cepInput || !btnBuscarCep) return;

    // Fun√ß√£o auxiliar para buscar campos de forma mais robusta
    function getFieldById(id) {
        if (!id) return null;
        // Tentar por ID primeiro
        let field = document.getElementById(id);
        if (field) return field;
        // Tentar sem o prefixo 'id_'
        const name = id.replace(/^id_/, '');
        field = document.querySelector(`[name="${name}"]`);
        if (field) return field;
        // Tentar buscar por qualquer atributo que contenha o nome
        field = document.querySelector(`[id*="${name}"], [name*="${name}"]`);
        return field;
    }

    // Campos ser√£o buscados dinamicamente dentro da fun√ß√£o preencherCamposEndereco

    // M√°scara de CEP
    cepInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 5) {
            value = value.substring(0, 5) + '-' + value.substring(5, 8);
        }
        e.target.value = value;
    });

    // Fun√ß√£o para buscar e preencher campos de endere√ßo
    function preencherCamposEndereco(data) {
        // Buscar campos novamente para garantir que estamos pegando os corretos
        const campos = {
            logradouro: getFieldById('{{ form.logradouro.id_for_label }}') || document.querySelector('[name="logradouro"]'),
            bairro: getFieldById('{{ form.bairro.id_for_label }}') || document.querySelector('[name="bairro"]'),
            cidade: getFieldById('{{ form.cidade.id_for_label }}') || document.querySelector('[name="cidade"]'),
            uf: getFieldById('{{ form.uf.id_for_label }}') || document.querySelector('[name="uf"]') || document.querySelector('[id*="uf"], [name*="uf"]')
        };

        // Fun√ß√£o auxiliar para preencher campo e disparar eventos
        function preencherCampo(field, value) {
            if (field && value) {
                field.value = value;
                // Disparar eventos para garantir que o valor seja reconhecido
                field.dispatchEvent(new Event('input', { bubbles: true, cancelable: true }));
                field.dispatchEvent(new Event('change', { bubbles: true, cancelable: true }));
                field.dispatchEvent(new Event('blur', { bubbles: true, cancelable: true }));
                return true;
            }
            return false;
        }

        // Preencher todos os campos
        const resultados = {
            logradouro: preencherCampo(campos.logradouro, data.street),
            bairro: preencherCampo(campos.bairro, data.district),
            cidade: preencherCampo(campos.cidade, data.city),
            uf: preencherCampo(campos.uf, (data.uf || '').toUpperCase())
        };

        // Log dos resultados
        console.log('Preenchimento de campos:', resultados);
        console.log('Dados recebidos:', data);

        // Se algum campo n√£o foi preenchido, tentar novamente ap√≥s um delay
        const camposNaoPreenchidos = Object.entries(resultados).filter(([_, preenchido]) => !preenchido);
        if (camposNaoPreenchidos.length > 0) {
            console.warn('Alguns campos n√£o foram preenchidos:', camposNaoPreenchidos.map(([nome]) => nome));
            setTimeout(() => {
                camposNaoPreenchidos.forEach(([nome]) => {
                    let campo = null;
                    switch(nome) {
                        case 'logradouro':
                            campo = getFieldById('{{ form.logradouro.id_for_label }}') || document.querySelector('[name="logradouro"]');
                            if (campo && data.street) preencherCampo(campo, data.street);
                            break;
                        case 'bairro':
                            campo = getFieldById('{{ form.bairro.id_for_label }}') || document.querySelector('[name="bairro"]');
                            if (campo && data.district) preencherCampo(campo, data.district);
                            break;
                        case 'cidade':
                            campo = getFieldById('{{ form.cidade.id_for_label }}') || document.querySelector('[name="cidade"]');
                            if (campo && data.city) preencherCampo(campo, data.city);
                            break;
                        case 'uf':
                            campo = getFieldById('{{ form.uf.id_for_label }}') || document.querySelector('[name="uf"]') || document.querySelector('[id*="uf"], [name*="uf"]');
                            if (campo && data.uf) preencherCampo(campo, data.uf.toUpperCase());
                            break;
                    }
                });
            }, 300);
        }

        return resultados;
    }

    // Fun√ß√£o para buscar CEP
    async function buscarCep() {
        const cep = cepInput.value.replace(/\D/g, '');
        if (cep.length !== 8) {
            alert('CEP deve conter 8 d√≠gitos.');
            return;
        }

        btnBuscarCep.disabled = true;
        btnBuscarCep.textContent = 'Buscando...';

        try {
            const resp = await fetch('{% url "system:api_buscar_cep" %}?cep=' + cep);
            const data = await resp.json();

            if (!resp.ok) {
                if (data.error) {
                    alert(data.error);
                }
                return;
            }

            // Preencher todos os campos de endere√ßo
            preencherCamposEndereco(data);

        } catch (e) {
            console.error('Erro ao buscar CEP:', e);
            alert('Erro ao buscar CEP. Tente novamente.');
        } finally {
            btnBuscarCep.disabled = false;
            btnBuscarCep.textContent = 'Buscar';
        }
    }

    btnBuscarCep.addEventListener('click', buscarCep);
    cepInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            buscarCep();
        }
    });
    
    // Mostrar/esconder campo tipo_passaporte_outro baseado na sele√ß√£o de tipo_passaporte
    (function() {
        function initTipoPassaporteToggle() {
            // Tentar encontrar o campo tipo_passaporte por ID ou name
            const tipoPassaporteSelect = document.getElementById('id_tipo_passaporte') || 
                                         document.querySelector('select[name="tipo_passaporte"]');
            const tipoPassaporteOutroDiv = document.getElementById('div_tipo_passaporte_outro');
            const tipoPassaporteOutroField = document.getElementById('id_tipo_passaporte_outro') || 
                                             document.querySelector('input[name="tipo_passaporte_outro"]');
            
            if (!tipoPassaporteSelect || !tipoPassaporteOutroDiv) {
                // Se n√£o encontrou, tentar novamente ap√≥s um pequeno delay
                setTimeout(initTipoPassaporteToggle, 100);
                return;
            }
            
            function toggleTipoPassaporteOutro() {
                if (tipoPassaporteSelect.value === 'outro') {
                    tipoPassaporteOutroDiv.style.display = 'block';
                    if (tipoPassaporteOutroField) {
                        tipoPassaporteOutroField.required = true;
                    }
                } else {
                    tipoPassaporteOutroDiv.style.display = 'none';
                    if (tipoPassaporteOutroField) {
                        tipoPassaporteOutroField.required = false;
                        tipoPassaporteOutroField.value = '';
                    }
                }
            }
            
            // Verificar estado inicial
            toggleTipoPassaporteOutro();
            
            // Adicionar listener
            tipoPassaporteSelect.addEventListener('change', toggleTipoPassaporteOutro);
        }
        
        // Inicializar quando o DOM estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initTipoPassaporteToggle);
        } else {
            initTipoPassaporteToggle();
        }
    })();
})();
</script>
    {% endif %}
{% endfor %}
{% endblock %}
