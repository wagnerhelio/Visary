{% extends "base.html" %}
{% load static %}

{% block title %}Visary | Editar Processo{% endblock %}

{% block base_styles %}
    {{ block.super }}

    .layout-grid {
        display: grid;
        gap: 24px;
    }

    .card {
        background: var(--card-bg);
        border-radius: 24px;
        border: 1px solid var(--border-soft);
        box-shadow: 0 24px 48px rgba(5, 8, 17, 0.5);
        padding: clamp(18px, 3.5vw, 28px);
    }

    .form-card form {
        display: grid;
        gap: 16px;
    }

    .form-card label {
        display: block;
        font-size: 0.82rem;
        font-weight: 600;
        color: rgba(245, 245, 245, 0.8);
        margin-bottom: 8px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
    }

    .form-card input,
    .form-card select,
    .form-card textarea {
        width: 100%;
        min-width: 0;
        padding: 14px 16px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(12, 19, 35, 0.72);
        color: #f5f5f5;
        font-size: 0.95rem;
        transition: border 0.2s ease, box-shadow 0.2s ease;
    }

    .form-card select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23f5f5f5' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 16px center;
        background-size: 12px;
        padding-right: 40px;
    }

    .form-card input:focus,
    .form-card select:focus,
    .form-card textarea:focus {
        outline: none;
        border-color: rgba(86, 244, 156, 0.6);
        box-shadow: 0 0 0 3px rgba(86, 244, 156, 0.1);
    }

    .form-card textarea {
        resize: vertical;
        min-height: 80px;
    }

    /* Checklist de Etapas */
    .checklist-etapas {
        display: grid;
        gap: 16px;
        margin-top: 24px;
    }

    .etapa-item {
        background: rgba(12, 19, 35, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 20px;
        transition: all 0.2s ease;
    }

    .etapa-item:hover {
        border-color: rgba(86, 244, 156, 0.3);
        background: rgba(12, 19, 35, 0.6);
    }

    .etapa-item.concluida {
        border-color: rgba(86, 244, 156, 0.5);
        background: rgba(86, 244, 156, 0.1);
    }

    .etapa-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
    }

    .etapa-header form {
        margin-left: auto;
    }

    .etapa-header .btn-remover-etapa {
        padding: 6px 12px;
        font-size: 0.85rem;
        background: rgba(255, 104, 104, 0.2);
        border: 1px solid rgba(255, 104, 104, 0.4);
        color: rgba(255, 104, 104, 0.9);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 500;
    }

    .etapa-header .btn-remover-etapa:hover {
        background: rgba(255, 104, 104, 0.3);
        border-color: rgba(255, 104, 104, 0.6);
        color: rgba(255, 104, 104, 1);
    }

    .etapa-checkbox {
        width: 24px;
        height: 24px;
        cursor: pointer;
        accent-color: rgba(86, 244, 156, 0.8);
    }

    .etapa-nome {
        flex: 1;
        font-size: 1rem;
        font-weight: 600;
        color: rgba(245, 245, 245, 0.95);
    }

    .etapa-item.concluida .etapa-nome {
        text-decoration: line-through;
        opacity: 0.7;
    }

    .etapa-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
        margin-top: 12px;
    }

    .etapa-info-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .etapa-info-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: rgba(245, 245, 245, 0.6);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .etapa-info-value {
        font-size: 0.9rem;
        color: rgba(245, 245, 245, 0.9);
    }

    .etapa-prazo-input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(12, 19, 35, 0.72);
        color: #f5f5f5;
        font-size: 0.9rem;
    }

    .etapa-observacoes {
        margin-top: 12px;
    }

    .etapa-observacoes textarea {
        width: 100%;
        min-height: 60px;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(12, 19, 35, 0.72);
        color: #f5f5f5;
        font-size: 0.9rem;
        resize: vertical;
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        overflow: hidden;
        margin-top: 8px;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, rgba(86, 244, 156, 0.8), rgba(86, 244, 156, 1));
        transition: width 0.3s ease;
    }

    @media (min-width: 1120px) {
        .layout-grid {
            max-width: 900px;
            margin: 0 auto;
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .layout-grid {
            max-width: 100%;
            margin-inline: auto;
        }

        .etapa-info {
            grid-template-columns: 1fr;
        }
    }
{% endblock %}

{% block app_header %}
<section class="page-header">
    <div class="page-header__titles">
        <h1>Editar Processo</h1>
        <p>Gerencie o processo e suas etapas (checklist).</p>
    </div>
    <div class="actions-inline">
        <a href="{% url 'system:listar_processos' %}" class="btn btn-outline">Voltar</a>
        {% if pode_gerenciar_todos %}
            <form method="post" action="{% url 'system:excluir_processo' processo.pk %}" onsubmit="return confirm('Deseja realmente excluir este processo?');" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger">Excluir</button>
            </form>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block app_content %}
<section class="layout-grid">
    {% if pode_gerenciar_todos %}
    <article class="card form-card">
        <header style="margin-bottom: 20px;">
            <h2>Informa√ß√µes do Processo</h2>
        </header>
        <form method="post">
            {% csrf_token %}
            <div>
                <label for="assessor_responsavel">Assessor Respons√°vel</label>
                <select id="assessor_responsavel" name="assessor_responsavel" required>
                    {% for assessor in assessores_disponiveis %}
                        <option value="{{ assessor.pk }}" {% if assessor.pk == processo.assessor_responsavel.pk %}selected{% endif %}>
                            {{ assessor.nome }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" name="alterar_assessor" class="btn btn-primary" style="margin-top: 16px;">Alterar Assessor</button>
        </form>
    </article>
    {% endif %}

    <article class="card">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <h2>Etapas do Processo (Checklist)</h2>
                <p style="margin: 8px 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">
                    Progresso: {{ processo.etapas_concluidas }}/{{ processo.total_etapas }} etapas conclu√≠das ({{ processo.progresso_percentual }}%)
                </p>
            </div>
        </header>

        <div class="progress-bar">
            <div class="progress-fill" style="width: {{ processo.progresso_percentual }}%;"></div>
        </div>

        <div class="checklist-etapas">
            {% for item in etapas_com_datas %}
                {% with etapa=item.etapa data_finalizacao=item.data_finalizacao %}
                    <div class="etapa-item {% if etapa.concluida %}concluida{% endif %}" data-etapa-id="{{ etapa.pk }}">
                        <form method="post" style="display: contents;">
                            {% csrf_token %}
                            <!-- Hidden input para garantir que checkbox desmarcado seja tratado -->
                            <input type="hidden" name="etapa_{{ etapa.pk }}_concluida_presente" value="1">
                            <div class="etapa-header">
                                <input 
                                    type="checkbox" 
                                    name="etapa_{{ etapa.pk }}_concluida" 
                                    id="etapa_{{ etapa.pk }}_concluida"
                                    class="etapa-checkbox"
                                    {% if etapa.concluida %}checked{% endif %}
                                    onchange="atualizarEstadoEtapa({{ etapa.pk }}, this.checked);">
                                <label for="etapa_{{ etapa.pk }}_concluida" class="etapa-nome">
                                    {{ etapa.status.nome }}
                                </label>
                                <button type="button" class="btn-remover-etapa" 
                                        onclick="if(confirm('Deseja realmente remover a etapa \'{{ etapa.status.nome }}\' deste processo?')) { var form = document.createElement('form'); form.method = 'post'; form.action = '{% url 'system:remover_etapa_processo' processo.pk etapa.pk %}'; var csrf = document.createElement('input'); csrf.type = 'hidden'; csrf.name = 'csrfmiddlewaretoken'; csrf.value = '{{ csrf_token }}'; form.appendChild(csrf); document.body.appendChild(form); form.submit(); }"
                                        title="Remover etapa">
                                    ‚úï Remover
                                </button>
                            </div>

                            <div class="etapa-info">
                                <div class="etapa-info-item">
                                    <span class="etapa-info-label">Prazo (dias)</span>
                                    <input 
                                        type="number" 
                                        name="etapa_{{ etapa.pk }}_prazo" 
                                        id="etapa_{{ etapa.pk }}_prazo"
                                        value="{% if etapa.prazo_dias %}{{ etapa.prazo_dias }}{% else %}{{ etapa.status.prazo_padrao_dias|default:0 }}{% endif %}"
                                        class="etapa-prazo-input"
                                        min="0"
                                        step="1"
                                        data-etapa-id="{{ etapa.pk }}"
                                        onchange="atualizarDataFinalizacao({{ etapa.pk }}, this.value)">
                                </div>

                                <div class="etapa-info-item">
                                    <span class="etapa-info-label">Data Finaliza√ß√£o</span>
                                    <span class="etapa-info-value" id="data_final_{{ etapa.pk }}">
                                        {% if data_finalizacao %}
                                            {{ data_finalizacao|date:"d/m/Y" }}
                                        {% else %}
                                            ‚Äî
                                        {% endif %}
                                    </span>
                                </div>

                                <div class="etapa-info-item">
                                    <span class="etapa-info-label">Data de Conclus√£o</span>
                                    <input 
                                        type="date" 
                                        name="etapa_{{ etapa.pk }}_data" 
                                        id="etapa_{{ etapa.pk }}_data"
                                        value="{% if etapa.data_conclusao %}{{ etapa.data_conclusao|date:'Y-m-d' }}{% endif %}"
                                        class="etapa-prazo-input"
                                        style="font-size: 0.85rem;">
                                </div>
                            </div>

                            <div class="etapa-observacoes">
                                <label for="etapa_{{ etapa.pk }}_obs" style="font-size: 0.75rem; margin-bottom: 6px; display: block;">
                                    Observa√ß√µes
                                </label>
                                <textarea 
                                    name="etapa_{{ etapa.pk }}_obs" 
                                    id="etapa_{{ etapa.pk }}_obs"
                                    placeholder="Adicione observa√ß√µes sobre esta etapa...">{{ etapa.observacoes }}</textarea>
                            </div>

                            <div style="margin-top: 16px;">
                                <button type="submit" name="salvar_etapa" value="{{ etapa.pk }}" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.9rem;">
                                    Salvar Esta Etapa
                                </button>
                            </div>
                        </form>
                    </div>
                {% endwith %}
            {% empty %}
                <p style="color: rgba(245, 245, 245, 0.6); text-align: center; padding: 40px 20px;">
                    Nenhuma etapa configurada para esta viagem. Configure as etapas na se√ß√£o de Status de Processo.
                </p>
            {% endfor %}
        </div>

        {% if etapas_com_datas %}
        <form method="post" id="form-salvar-tudo" action="{% url 'system:editar_processo' processo.pk %}" style="margin-top: 24px;" onsubmit="return coletarValoresTodasEtapas(event);">
            {% csrf_token %}
            <button type="submit" name="salvar_tudo" value="1" class="btn btn-primary" id="btn-salvar-tudo">Salvar Todas as Etapas</button>
        </form>
        <script>
            // Garantir que a fun√ß√£o seja chamada mesmo se houver problemas
            document.addEventListener('DOMContentLoaded', function() {
                const form = document.getElementById('form-salvar-tudo');
                const btn = document.getElementById('btn-salvar-tudo');
                
                if (form && btn) {
                    // Adicionar listener adicional como backup
                    btn.addEventListener('click', function(e) {
                        console.log('üîµ Bot√£o clicado - listener adicional');
                        if (e.defaultPrevented) {
                            console.log('‚ö†Ô∏è  Evento j√° foi prevenido');
                        }
                    });
                    
                    form.addEventListener('submit', function(e) {
                        console.log('üîµ Evento submit capturado no form');
                    });
                }
            });
        </script>
        {% endif %}
    </article>

    {% if etapas_disponiveis %}
    <article class="card">
        <header style="margin-bottom: 20px;">
            <h2>Etapas Dispon√≠veis para Adicionar</h2>
            <p style="margin: 8px 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">
                Etapas que foram removidas ou ainda n√£o foram adicionadas ao processo.
            </p>
        </header>

        <div class="checklist-etapas">
            {% for status in etapas_disponiveis %}
                <div class="etapa-item" style="opacity: 0.8; border-color: rgba(86, 244, 156, 0.3);">
                    <div class="etapa-header">
                        <div class="etapa-nome" style="flex: 1;">
                            {{ status.nome }}
                        </div>
                        <form method="post" action="{% url 'system:adicionar_etapa_processo' processo.pk status.pk %}" 
                              style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-primary" style="padding: 6px 12px; font-size: 0.85rem;" title="Adicionar etapa">
                                + Adicionar
                            </button>
                        </form>
                    </div>
                    {% if status.prazo_padrao_dias %}
                    <div class="etapa-info">
                        <div class="etapa-info-item">
                            <span class="etapa-info-label">Prazo Padr√£o</span>
                            <span class="etapa-info-value">{{ status.prazo_padrao_dias }} dias</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    </article>
    {% endif %}
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const dataBase = new Date('{{ data_base|date:"Y-m-d" }}');
    
    function atualizarDataFinalizacao(etapaId, prazoDias) {
        const prazo = parseInt(prazoDias) || 0;
        const dataSpan = document.getElementById('data_final_' + etapaId);
        
        if (prazo > 0 && dataBase) {
            const dataFinal = new Date(dataBase);
            dataFinal.setDate(dataFinal.getDate() + prazo);
            dataSpan.textContent = dataFinal.toLocaleDateString('pt-BR');
        } else {
            dataSpan.textContent = '‚Äî';
        }
    }

    // Inicializar todas as datas de finaliza√ß√£o
    document.querySelectorAll('.etapa-prazo-input[data-etapa-id]').forEach(function(input) {
        const etapaId = input.dataset.etapaId;
        atualizarDataFinalizacao(etapaId, input.value);
    });
});

function atualizarEstadoEtapa(etapaId, concluida) {
    // Atualizar classe visual do item da etapa
    const etapaItem = document.querySelector(`.etapa-item[data-etapa-id="${etapaId}"]`);
    if (etapaItem) {
        etapaItem.classList.toggle('concluida', concluida);
    }
    
    // Se marcado como conclu√≠da, preencher data de conclus√£o com hoje (se estiver vazia)
    if (concluida) {
        const dataConclusaoInput = document.getElementById('etapa_' + etapaId + '_data');
        if (dataConclusaoInput && !dataConclusaoInput.value) {
            // Obter data de hoje no formato YYYY-MM-DD
            const hoje = new Date();
            const ano = hoje.getFullYear();
            const mes = String(hoje.getMonth() + 1).padStart(2, '0');
            const dia = String(hoje.getDate()).padStart(2, '0');
            const dataHoje = `${ano}-${mes}-${dia}`;
            dataConclusaoInput.value = dataHoje;
        }
    }
}

function coletarValoresTodasEtapas(event) {
    console.log('üîµ coletarValoresTodasEtapas: Fun√ß√£o chamada');
    console.log('üîµ Event:', event);
    
    // Sempre prevenir o comportamento padr√£o
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    const form = document.getElementById('form-salvar-tudo');
    if (!form) {
        console.error('‚ùå Erro: formul√°rio n√£o encontrado');
        console.error('‚ùå Tentando encontrar formul√°rio alternativo...');
        const forms = document.querySelectorAll('form');
        console.log('üìã Formul√°rios encontrados na p√°gina:', forms.length);
        alert('Erro: formul√°rio n√£o encontrado. Verifique o console para mais detalhes.');
        return false;
    }
    
    console.log('‚úÖ Formul√°rio encontrado:', form);
    console.log('‚úÖ Form action:', form.action);
    console.log('‚úÖ Form method:', form.method);
    
    // Limpar TODOS os inputs hidden relacionados a etapas
    const allHidden = form.querySelectorAll('input[type="hidden"]');
    console.log('üóëÔ∏è  Removendo', allHidden.length, 'campos hidden existentes');
    allHidden.forEach(function(input) {
        if (input.name && input.name.startsWith('etapa_')) {
            input.remove();
        }
    });
    
    // Coletar todos os valores de todas as etapas
    const etapaItems = document.querySelectorAll('.etapa-item[data-etapa-id]');
    console.log('üìã Etapas encontradas:', etapaItems.length);
    if (etapaItems.length === 0) {
        console.error('‚ùå Nenhuma etapa encontrada');
        alert('Nenhuma etapa encontrada para salvar');
        return false;
    }
    
    let camposAdicionados = 0;
    const dadosColetados = [];
    
    etapaItems.forEach(function(etapaItem) {
        const etapaId = etapaItem.dataset.etapaId;
        const etapaDados = {etapaId: etapaId};
        
        // 1. Checkbox conclu√≠da - SEMPRE coletar usando getElementById (mais confi√°vel)
        const checkbox = document.getElementById('etapa_' + etapaId + '_concluida');
        if (checkbox !== null) {
            const hiddenCheckbox = document.createElement('input');
            hiddenCheckbox.type = 'hidden';
            hiddenCheckbox.name = 'etapa_' + etapaId + '_concluida';
            // IMPORTANTE: Sempre enviar 'on' se marcado, ou campo vazio se desmarcado
            // O backend verifica se o valor √© 'on' para determinar se est√° conclu√≠da
            hiddenCheckbox.value = checkbox.checked ? 'on' : '';
            form.appendChild(hiddenCheckbox);
            camposAdicionados++;
            etapaDados.concluida = checkbox.checked;
        } else {
            console.warn('Checkbox n√£o encontrado para etapa ' + etapaId);
        }
        
        // 2. Prazo - usar getElementById como fallback
        let prazoInput = document.getElementById('etapa_' + etapaId + '_prazo');
        if (!prazoInput) {
            prazoInput = document.querySelector(`input[name="etapa_${etapaId}_prazo"]`);
        }
        if (!prazoInput) {
            // Tentar encontrar dentro do etapaItem
            prazoInput = etapaItem.querySelector(`input[type="number"][name*="${etapaId}_prazo"]`);
        }
        if (prazoInput) {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'etapa_' + etapaId + '_prazo';
            const prazoValue = prazoInput.value.trim();
            hiddenInput.value = prazoValue || '0';
            form.appendChild(hiddenInput);
            camposAdicionados++;
            etapaDados.prazo = hiddenInput.value;
        } else {
            console.warn('Campo prazo n√£o encontrado para etapa ' + etapaId);
        }
        
        // 3. Data conclus√£o - usar getElementById primeiro
        let dataInput = document.getElementById('etapa_' + etapaId + '_data');
        if (!dataInput) {
            dataInput = document.querySelector(`input[name="etapa_${etapaId}_data"]`);
        }
        if (!dataInput) {
            // Tentar encontrar dentro do etapaItem
            dataInput = etapaItem.querySelector(`input[type="date"][name*="${etapaId}_data"]`);
        }
        if (dataInput) {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'etapa_' + etapaId + '_data';
            hiddenInput.value = dataInput.value.trim() || '';
            form.appendChild(hiddenInput);
            camposAdicionados++;
            etapaDados.data = hiddenInput.value;
        }
        
        // 4. Observa√ß√µes - usar getElementById primeiro
        let obsTextarea = document.getElementById('etapa_' + etapaId + '_obs');
        if (!obsTextarea) {
            obsTextarea = document.querySelector(`textarea[name="etapa_${etapaId}_obs"]`);
        }
        if (!obsTextarea) {
            // Tentar encontrar dentro do etapaItem
            obsTextarea = etapaItem.querySelector(`textarea[name*="${etapaId}_obs"]`);
        }
        if (obsTextarea) {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'etapa_' + etapaId + '_obs';
            hiddenInput.value = obsTextarea.value.trim() || '';
            form.appendChild(hiddenInput);
            camposAdicionados++;
            etapaDados.obs = hiddenInput.value.length;
        }
        
        dadosColetados.push(etapaDados);
    });
    
    // Verificar se coletou algum campo
    console.log('üìä Total de campos adicionados:', camposAdicionados);
    console.log('üìä Dados coletados:', dadosColetados);
    
    if (camposAdicionados === 0) {
        console.error('‚ùå Erro: Nenhum campo foi coletado das etapas.');
        alert('Erro: Nenhum campo foi coletado das etapas.');
        return false;
    }
    
    // Verificar se todas as etapas foram processadas
    const camposEsperados = etapaItems.length * 4; // checkbox, prazo, data, obs
    if (camposAdicionados < camposEsperados) {
        console.warn('‚ö†Ô∏è  Aviso: Nem todos os campos foram coletados. Esperado:', camposEsperados, 'Coletado:', camposAdicionados);
    }
    
    // Verificar se o formul√°rio tem CSRF token
    const csrfToken = form.querySelector('input[name="csrfmiddlewaretoken"]');
    if (!csrfToken) {
        console.error('‚ùå Erro: CSRF token n√£o encontrado no formul√°rio');
        alert('Erro: Token de seguran√ßa n√£o encontrado. Recarregue a p√°gina e tente novamente.');
        return false;
    }
    
    // IMPORTANTE: Garantir que o bot√£o salvar_tudo seja inclu√≠do no POST
    // Como estamos fazendo preventDefault, o bot√£o n√£o ser√° inclu√≠do automaticamente
    let salvarTudoInput = form.querySelector('input[name="salvar_tudo"]');
    if (!salvarTudoInput) {
        salvarTudoInput = document.createElement('input');
        salvarTudoInput.type = 'hidden';
        salvarTudoInput.name = 'salvar_tudo';
        salvarTudoInput.value = '1';
        form.appendChild(salvarTudoInput);
        console.log('‚úÖ Campo salvar_tudo adicionado ao formul√°rio');
    } else {
        console.log('‚úÖ Campo salvar_tudo j√° existe no formul√°rio');
    }
    
    console.log('‚úÖ Todos os campos coletados. Submetendo formul√°rio...');
    const camposParaEnviar = Array.from(form.querySelectorAll('input[type="hidden"]'));
    console.log('üì§ Total de campos hidden:', camposParaEnviar.length);
    console.log('üì§ Campos que ser√£o enviados:', camposParaEnviar.map(input => `${input.name}=${input.value.substring(0, 50)}`));
    
    // Verificar se h√° campos antes de submeter
    if (camposParaEnviar.length === 0) {
        console.error('‚ùå Erro: Nenhum campo hidden encontrado no formul√°rio');
        alert('Erro: Nenhum campo foi coletado. Verifique o console para mais detalhes.');
        return false;
    }
    
    // Verificar se salvar_tudo est√° presente
    const salvarTudoPresente = camposParaEnviar.some(input => input.name === 'salvar_tudo');
    if (!salvarTudoPresente) {
        console.error('‚ùå Erro: Campo salvar_tudo n√£o encontrado nos campos para enviar');
        alert('Erro: Campo salvar_tudo n√£o encontrado. Recarregue a p√°gina e tente novamente.');
        return false;
    }
    console.log('‚úÖ Campo salvar_tudo confirmado nos campos para enviar');
    
    // Mostrar visualmente que est√° submetendo
    const submitButton = form.querySelector('button[type="submit"]');
    if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = 'Salvando...';
    }
    
    // For√ßar submiss√£o do formul√°rio
    console.log('üì§ Submetendo formul√°rio agora...');
    try {
        // Criar um evento de submit para garantir que o Django receba corretamente
        const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
        form.dispatchEvent(submitEvent);
        
        // Se o evento n√£o foi cancelado, fazer o submit
        if (!submitEvent.defaultPrevented) {
            form.submit();
            console.log('‚úÖ Formul√°rio submetido com sucesso');
        } else {
            console.warn('‚ö†Ô∏è  Submit foi cancelado');
        }
    } catch (error) {
        console.error('‚ùå Erro ao submeter formul√°rio:', error);
        console.error('‚ùå Stack trace:', error.stack);
        alert('Erro ao submeter formul√°rio: ' + error.message + '\n\nVerifique o console para mais detalhes.');
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = 'Salvar Todas as Etapas';
        }
        return false;
    }
    
    return false;
}
</script>
{% endblock %}
